<div class="conversation" *ngIf="(projectConfigService.project$|async) as project">

  <div class="display">
    <mat-tab-group>
      <mat-tab label="Output">
        <div class="output">
          <ul *ngIf="output" class="entries">
            <li *ngFor="let entry of output">
              <div class="errorEntry" *ngIf="entry.error">
                {{entry.error}}
              </div>

              <ul class="entry" *ngIf="!entry.error">



                <li>
                  <label>intent</label>
                  <span>{{entry.intent}}</span>
                </li>

                <li>
                  <ng-container *ngIf="entry.immersive">
                    <ul class="immersiveResponse">


                      <li *ngIf="entry.loadImmersiveUrl">
                        <label>loadImmersiveUrl</label>
                        <div>{{entry.loadImmersiveUrl}}</div>
                      </li>
                      <li *ngIf="entry.updatedState">
                        <label>updatedState</label>
                        <ul class="updatedStateProperties">
                          <li *ngFor="let propName of entry.updatedStateProperties">
                            <label>
                              {{propName}}
                            </label>
                            <ng-container *ngIf="!entry.updatedStateSubproperties[propName]">
                              <span>
                                {{entry.updatedState[propName]}}
                              </span>
                            </ng-container>
                            <ng-container *ngIf="entry.updatedStateSubproperties[propName]">
                              <ul class="updatedStateSubproperties"
                                *ngFor="let subpropName of entry.updatedStateSubproperties[propName]">
                                <li>
                                  <label>
                                    {{subpropName}}
                                  </label>
                                  <span>
                                    {{entry.updatedState[propName][subpropName]}}
                                  </span>
                                </li>
                              </ul>
                            </ng-container>

                          </li>
                        </ul>

                      </li>

                    </ul>

                  </ng-container>


                </li>

              </ul>

            </li>
          </ul>
        </div>


      </mat-tab>
      <mat-tab label="Simulator">
        <div class="simulator">

        </div>
      </mat-tab>


    </mat-tab-group>

  </div>

  <div class="controls">
    <h2>{{project.name}}</h2>
    <div class="user-controls">

      <div *ngIf="!newUser" class="user">


        <mat-form-field>
          <mat-label>user</mat-label>
          <mat-select [(ngModel)]="user">
            <mat-option *ngFor="let user of users" [value]="user">{{user.id}}</mat-option>
          </mat-select>
        </mat-form-field>

        <div class="user-details" *ngIf="user">
          <div><label>locale</label> {{user.locale}}</div>
          <div><label>lastSeen</label> {{user.lastSeen ? user.lastSeen : 'undefined'}}</div>
        </div>

        <button mat-icon-button (click)="newUser=true">
          <mat-icon>add</mat-icon>
        </button>

      </div>




      <div *ngIf="newUser" class="newUser">


        <mat-form-field>
          <mat-label>locale</mat-label>
          <mat-select [value]="newUserDefaults.locale" #newUserLocale>
            <mat-option *ngFor="let locale of locales" [value]="locale">{{locale}}</mat-option>
          </mat-select>
        </mat-form-field>



        <mat-slide-toggle [checked]="newUserDefaults.returning" #newUserReturning>returning</mat-slide-toggle>

        <button mat-raised-button
          (click)="addUser({locale: newUserLocale.value, returning: newUserReturning.checked})">add</button>
        <button mat-raised-button (click)="newUser=false">cancel</button>

      </div>


    </div>


    <div class="session" *ngIf="user">
      <h3>session</h3>
      <div *ngIf="!session" class="sessionControls">
        <button mat-raised-button (click)="invoke()">invoke app</button>
        <mat-slide-toggle *ngIf="allowCustomStage" [(ngModel)]="customStage">custom stage</mat-slide-toggle>
      </div>
      <div *ngIf="session">

        <div class="sessionInfo">
          <div><label>conversationId</label>&nbsp;<span>{{session.conversationId}}</span></div>
          <div><label>custom stage</label>&nbsp;<span>{{session.customStage}}</span></div>
        </div>

        <ul class="sessionIntents">
          <ng-container *ngFor="let prompt of project.activePrompts">

            <li>
              <ng-container *ngIf="prompt.startsWith('$')">
                <button mat-raised-button (click)="query(prompt,qText.value)">{{prompt}}</button>
                &nbsp;
                <input type="text" size="30" #qText>
              </ng-container>
              <ng-container *ngIf="!prompt.startsWith('$')">
                <button mat-raised-button (click)="query(prompt,'')">{{prompt}}</button>
              </ng-container>
            </li>
          </ng-container>


          <li><button mat-raised-button (click)="quit()">quit</button></li>
        </ul>
      </div>
    </div>

  </div>
</div>